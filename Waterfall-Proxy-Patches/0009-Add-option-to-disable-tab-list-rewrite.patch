From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: MrIvanPlays <pekov.ivan@abv.bg>
Date: Thu, 13 Jun 2019 18:03:14 +0300
Subject: [PATCH] Add option to disable tab list rewrite


diff --git a/api/src/main/java/net/md_5/bungee/api/ProxyConfig.java b/api/src/main/java/net/md_5/bungee/api/ProxyConfig.java
index 41f72e0b23be328e5161679917ab9b82a0546e0d..809c5ab9ae228016e05809d236a0ed5fa69661ad 100644
--- a/api/src/main/java/net/md_5/bungee/api/ProxyConfig.java
+++ b/api/src/main/java/net/md_5/bungee/api/ProxyConfig.java
@@ -249,5 +249,13 @@ public interface ProxyConfig
      * @return should the player kicked be transferred to lobby
      */
     boolean isKickToLobby();
+
+    /**
+     * If this is true, the tab list rewriting will be disabled.
+     *
+     * @return should proxy rewrite TabList
+     */
+    boolean isDisableTabListRewrite();
+
     // IvanCord end
 }
diff --git a/proxy/src/main/java/com/mrivanplays/ivancord/conf/IvanCordConfiguration.java b/proxy/src/main/java/com/mrivanplays/ivancord/conf/IvanCordConfiguration.java
index 238bc3c1f43aa5bd6de34f4355ede2dee818fef3..996c02b848c32e44abadb7ddeff9e59d57bc4449 100644
--- a/proxy/src/main/java/com/mrivanplays/ivancord/conf/IvanCordConfiguration.java
+++ b/proxy/src/main/java/com/mrivanplays/ivancord/conf/IvanCordConfiguration.java
@@ -11,6 +11,7 @@ public class IvanCordConfiguration extends WaterfallConfiguration
 {
 
     private boolean kickToLobby = true;
+    private boolean disableTabListRewrite = isOnlineMode();
 
     @Override
     public void load()
@@ -19,5 +20,6 @@ public class IvanCordConfiguration extends WaterfallConfiguration
         YamlConfig config = new YamlConfig( new File( "ivancord.yml" ) );
         config.load( false );
         kickToLobby = config.getBoolean( "kick_to_lobby", kickToLobby );
+        disableTabListRewrite = config.getBoolean( "disable_tablist_rewrite", disableTabListRewrite );
     }
 }
diff --git a/proxy/src/main/java/net/md_5/bungee/connection/DownstreamBridge.java b/proxy/src/main/java/net/md_5/bungee/connection/DownstreamBridge.java
index af202e5475b97e6672c7eda29567f40c895ef776..8fd0e2a5380a3e3f862eddc35d286c6c9e3afbca 100644
--- a/proxy/src/main/java/net/md_5/bungee/connection/DownstreamBridge.java
+++ b/proxy/src/main/java/net/md_5/bungee/connection/DownstreamBridge.java
@@ -173,8 +173,19 @@ public class DownstreamBridge extends PacketHandler
     @Override
     public void handle(PlayerListItem playerList) throws Exception
     {
+        // IvanCord start - rewrite the following code
+        /*
         con.getTabListHandler().onUpdate( TabList.rewrite( playerList ) );
         throw CancelSendSignal.INSTANCE; // Always throw because of profile rewriting
+         */
+        boolean skipRewrite = bungee.getConfig().isDisableTabListRewrite();
+        con.getTabListHandler().onUpdate( skipRewrite ? playerList : TabList.rewrite( playerList ) );
+        if ( !skipRewrite )
+        {
+            // only throw when we do rewriting
+            throw CancelSendSignal.INSTANCE;
+        }
+        // IvanCord end
     }
 
     // IvanCord start - remove these from handling
