From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: MrIvanPlays <ivan@mrivanplays.com>
Date: Wed, 27 May 2020 13:39:59 +0300
Subject: [PATCH] Add BrigadierCommandDeclareEvent


diff --git a/api/src/main/java/com/mrivanplays/ivancord/api/event/BrigadierCommandDeclareEvent.java b/api/src/main/java/com/mrivanplays/ivancord/api/event/BrigadierCommandDeclareEvent.java
new file mode 100644
index 0000000000000000000000000000000000000000..4fc2d0a6e4cdaf760edfb5fcd8edf4dfd1df1089
--- /dev/null
+++ b/api/src/main/java/com/mrivanplays/ivancord/api/event/BrigadierCommandDeclareEvent.java
@@ -0,0 +1,44 @@
+package com.mrivanplays.ivancord.api.event;
+
+import com.mojang.brigadier.tree.LiteralCommandNode;
+import lombok.EqualsAndHashCode;
+import lombok.Getter;
+import lombok.Setter;
+import net.md_5.bungee.api.connection.Connection;
+import net.md_5.bungee.api.event.TargetedEvent;
+import net.md_5.bungee.api.plugin.Command;
+
+/**
+ * Event, called when the proxy sends 1.13+ commands to the client.
+ */
+@Getter
+@EqualsAndHashCode(callSuper = false)
+public class BrigadierCommandDeclareEvent extends TargetedEvent
+{
+
+    /**
+     * The alias the proxy wants to declare for the specified command.
+     */
+    private final String declaredAlias;
+
+    /**
+     * The command the proxy wants to declare
+     */
+    private final Command command;
+
+    /**
+     * The brigadier node sent to the client for the command alias.
+     * <p>
+     * <b>WARNING</b>: This is null by default. If it stays null after the
+     * event handling is done, the proxy will send a dummy node.
+     */
+    @Setter
+    private LiteralCommandNode<?> brigadierNode = null;
+
+    public BrigadierCommandDeclareEvent(Connection sender, Connection receiver, String declaredAlias, Command command)
+    {
+        super( sender, receiver );
+        this.declaredAlias = declaredAlias;
+        this.command = command;
+    }
+}
diff --git a/proxy/src/main/java/net/md_5/bungee/connection/DownstreamBridge.java b/proxy/src/main/java/net/md_5/bungee/connection/DownstreamBridge.java
index 4bf74775ad072cb759f280aeae993665850a5708..b0eb1682e925e2ed8074f08ee64628fce15c805d 100644
--- a/proxy/src/main/java/net/md_5/bungee/connection/DownstreamBridge.java
+++ b/proxy/src/main/java/net/md_5/bungee/connection/DownstreamBridge.java
@@ -81,6 +81,7 @@ import net.md_5.bungee.tab.TabList;
 // IvanCord start
 import com.mrivanplays.ivancord.api.Position;
 import com.mrivanplays.ivancord.api.event.PlayerChangePositionEvent;
+import com.mrivanplays.ivancord.api.event.BrigadierCommandDeclareEvent;
 // IvanCord end
 
 @RequiredArgsConstructor
@@ -731,7 +732,19 @@ public class DownstreamBridge extends PacketHandler
                         .then( RequiredArgumentBuilder.argument( "args", StringArgumentType.greedyString() )
                                 .suggests( Commands.SuggestionRegistry.ASK_SERVER ) )
                         .build();
+
+                // IvanCord start - call BrigadierCommandDeclareEvent
+                BrigadierCommandDeclareEvent cde = new BrigadierCommandDeclareEvent( this.server, this.con, command.getKey(), command.getValue() );
+                bungee.getPluginManager().callEvent( cde );
+
+                if ( cde.getBrigadierNode() == null )
+                {
                 commands.getRoot().addChild( dummy );
+                } else
+                {
+                    commands.getRoot().addChild( cde.getBrigadierNode() );
+                }
+                // IvanCord end
 
                 modified = true;
             }
