From e4aa688bf3193a0ff7d5217297e61095e8257180 Mon Sep 17 00:00:00 2001
From: MrIvanPlays <pekov.ivan@abv.bg>
Date: Tue, 25 Jun 2019 16:03:22 +0300
Subject: [PATCH] Add LoginCancelledEvent


diff --git a/api/src/main/java/com/github/mrivanplays/ivancord/api/event/LoginCancelledEvent.java b/api/src/main/java/com/github/mrivanplays/ivancord/api/event/LoginCancelledEvent.java
new file mode 100644
index 000000000..357b94c13
--- /dev/null
+++ b/api/src/main/java/com/github/mrivanplays/ivancord/api/event/LoginCancelledEvent.java
@@ -0,0 +1,73 @@
+/*
+ * Copyright 2019 Ivan Pekov (MrIvanPlays)
+
+ * Permission is hereby granted, free of charge, to any person obtaining a copy of
+ * this software and associated documentation files (the "Software"), to deal in the
+ * Software without restriction, including without limitation the rights to use, copy,
+ * modify, merge, publish, distribute, sublicense, and/or sell copies of the Software,
+ * and to permit persons to whom the Software is furnished to do so, subject to the following conditions:
+
+ * The above copyright notice and this permission notice shall be included in all copies
+ * or substantial portions of the Software.
+
+ * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
+ * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
+ * OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
+ * IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
+ * DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,
+ * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
+ **/
+package com.github.mrivanplays.ivancord.api.event;
+
+import lombok.AllArgsConstructor;
+import lombok.Getter;
+import net.md_5.bungee.api.connection.PendingConnection;
+import net.md_5.bungee.api.plugin.Event;
+
+/**
+ * Represents a event, called when login process is aborted/cancelled
+ * by the logging player or the proxy. In most of the times, the event
+ * is being triggered by the logging player pressing the "Cancel"
+ * button on the client.
+ */
+@Getter
+@AllArgsConstructor
+public class LoginCancelledEvent extends Event
+{
+
+    /**
+     * The pending connection, which aborted their login process
+     */
+    private PendingConnection connection;
+
+    /**
+     * The reason of which the event was being triggered
+     */
+    private CancelReason cancelReason;
+
+    /**
+     * Represents a cancel reason
+     */
+    public static enum CancelReason
+    {
+
+        /**
+         * The client aborted the login process by the user
+         * pressing the "Cancel" button
+         */
+        CLIENT,
+
+        /**
+         * {@link net.md_5.bungee.api.event.LoginEvent} or
+         * {@link net.md_5.bungee.api.event.PreLoginEvent} are getting cancelled
+         */
+        PROXY,
+
+        /**
+         * Exception were caught during login process and the
+         * proxy cancelled the login process
+         */
+        PROXY_EXCEPTION
+        ;
+    }
+}
diff --git a/proxy/src/main/java/net/md_5/bungee/connection/InitialHandler.java b/proxy/src/main/java/net/md_5/bungee/connection/InitialHandler.java
index 3a9dab682..b67fd1a67 100644
--- a/proxy/src/main/java/net/md_5/bungee/connection/InitialHandler.java
+++ b/proxy/src/main/java/net/md_5/bungee/connection/InitialHandler.java
@@ -65,6 +65,8 @@ import net.md_5.bungee.util.BoundedArrayList;
 import net.md_5.bungee.util.BufUtil;
 import net.md_5.bungee.util.QuietException;
 
+import com.github.mrivanplays.ivancord.api.event.LoginCancelledEvent;
+
 @RequiredArgsConstructor
 public class InitialHandler extends PacketHandler implements PendingConnection
 {
@@ -126,6 +128,9 @@ public class InitialHandler extends PacketHandler implements PendingConnection
     @Override
     public void exception(Throwable t) throws Exception
     {
+        // IvanCord start - implement LoginCancelledEvent
+        new LoginCancelledEvent( InitialHandler.this, LoginCancelledEvent.CancelReason.PROXY_EXCEPTION ).call();
+        // IvanCord end
         disconnect( ChatColor.RED + Util.exception( t ) );
     }
 
@@ -379,11 +384,17 @@ public class InitialHandler extends PacketHandler implements PendingConnection
             {
                 if ( result.isCancelled() )
                 {
+                    // IvanCord start - implement LoginCancelledEvent
+                    new LoginCancelledEvent( InitialHandler.this, LoginCancelledEvent.CancelReason.PROXY ).call();
+                    // IvanCord end
                     disconnect( result.getCancelReasonComponents() );
                     return;
                 }
                 if ( ch.isClosed() )
                 {
+                    // IvanCord start - implement LoginCancelledEvent
+                    new LoginCancelledEvent( InitialHandler.this, LoginCancelledEvent.CancelReason.CLIENT ).call();
+                    // IvanCord end
                     return;
                 }
                 if ( onlineMode )
@@ -500,11 +511,17 @@ public class InitialHandler extends PacketHandler implements PendingConnection
             {
                 if ( result.isCancelled() )
                 {
+                    // IvanCord start - implement login cancelled event
+                    new LoginCancelledEvent( InitialHandler.this, LoginCancelledEvent.CancelReason.PROXY ).call();
+                    // IvanCord end
                     disconnect( result.getCancelReasonComponents() );
                     return;
                 }
                 if ( ch.isClosed() )
                 {
+                    // IvanCord start - implement LoginCancelledEvent
+                    new LoginCancelledEvent( InitialHandler.this, LoginCancelledEvent.CancelReason.CLIENT ).call();
+                    // IvanCord end
                     return;
                 }
 
@@ -513,6 +530,8 @@ public class InitialHandler extends PacketHandler implements PendingConnection
                     @Override
                     public void run()
                     {
+                        // IvanCord start - recreate this in favour of LoginCancelledEvent
+                        /*
                         if ( !ch.isClosing() )
                         {
                             UserConnection userCon = new UserConnection( bungee, ch, getName(), InitialHandler.this );
@@ -541,6 +560,38 @@ public class InitialHandler extends PacketHandler implements PendingConnection
 
                             thisState = State.FINISHED;
                         }
+                         */
+                        if ( ch.isClosing() )
+                        {
+                            new LoginCancelledEvent( InitialHandler.this, LoginCancelledEvent.CancelReason.CLIENT ).call();
+                            return;
+                        }
+                        UserConnection userCon = new UserConnection( bungee, ch, getName(), InitialHandler.this );
+                        userCon.setCompressionThreshold( BungeeCord.getInstance().config.getCompressionThreshold() );
+                        userCon.init();
+
+                        unsafe.sendPacket( new LoginSuccess( getUniqueId().toString(), getName() ) ); // With dashes in between
+                        ch.setProtocol( Protocol.GAME );
+
+                        ch.getHandle().pipeline().get( HandlerBoss.class ).setHandler( new UpstreamBridge( bungee, userCon ) );
+                        bungee.getPluginManager().callEvent( new PostLoginEvent( userCon ) );
+                        ServerInfo server;
+                        if ( bungee.getReconnectHandler() != null )
+                        {
+                            server = bungee.getReconnectHandler().getServer( userCon );
+                        } else
+                        {
+                            server = AbstractReconnectHandler.getForcedHost( InitialHandler.this );
+                        }
+                        if ( server == null )
+                        {
+                            server = bungee.getServerInfo( listener.getDefaultServer() );
+                        }
+
+                        userCon.connect( server, null, true, ServerConnectEvent.Reason.JOIN_PROXY );
+
+                        thisState = State.FINISHED;
+                        // IvanCord end
                     }
                 } );
             }
-- 
2.22.0.windows.1

