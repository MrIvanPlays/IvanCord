From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Gerrygames <gecam59@gmail.com>
Date: Tue, 13 Oct 2020 18:21:24 +0300
Subject: [PATCH] Fix infinite relay message accumulation

Co-authored-by: Ivan Pekov <ivan@mrivanplays.com>

diff --git a/proxy/src/main/java/net/md_5/bungee/connection/InitialHandler.java b/proxy/src/main/java/net/md_5/bungee/connection/InitialHandler.java
index 96c940c11e82ce8dc079de8125dae7423c3e46c0..a99be0dc5d4e428d0bf5af675cbab1d1d0727233 100644
--- a/proxy/src/main/java/net/md_5/bungee/connection/InitialHandler.java
+++ b/proxy/src/main/java/net/md_5/bungee/connection/InitialHandler.java
@@ -161,7 +161,7 @@ public class InitialHandler extends PacketHandler implements PendingConnection
     public void handle(PluginMessage pluginMessage) throws Exception
     {
         // TODO: Unregister?
-        if ( PluginMessage.SHOULD_RELAY.apply( pluginMessage ) )
+        if ( PluginMessage.SHOULD_RELAY.apply( pluginMessage ) && !relayMessages.contains( pluginMessage ) ) // IvanCord
         {
             relayMessages.add( pluginMessage );
         }
diff --git a/proxy/src/main/java/net/md_5/bungee/connection/UpstreamBridge.java b/proxy/src/main/java/net/md_5/bungee/connection/UpstreamBridge.java
index 611c443cc29ecf6b96a85373ce81bcd4615d1762..02abaf4fac8de610b87387e61f31ecf754812d84 100644
--- a/proxy/src/main/java/net/md_5/bungee/connection/UpstreamBridge.java
+++ b/proxy/src/main/java/net/md_5/bungee/connection/UpstreamBridge.java
@@ -379,7 +379,7 @@ public class UpstreamBridge extends PacketHandler
         }
 
         // TODO: Unregister as well?
-        if ( PluginMessage.SHOULD_RELAY.apply( pluginMessage ) )
+        if ( PluginMessage.SHOULD_RELAY.apply( pluginMessage ) && !con.getPendingConnection().getRelayMessages().contains( pluginMessage ) ) // IvanCord
         {
             con.getPendingConnection().getRelayMessages().add( pluginMessage );
         }
