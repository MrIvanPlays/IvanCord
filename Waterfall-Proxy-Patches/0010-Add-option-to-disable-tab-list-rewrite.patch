From 18df3caa648859eface987e918699d722d7fce03 Mon Sep 17 00:00:00 2001
From: MrIvanPlays <pekov.ivan@abv.bg>
Date: Thu, 13 Jun 2019 18:03:14 +0300
Subject: [PATCH] Add option to disable tab list rewrite


diff --git a/api/src/main/java/net/md_5/bungee/api/ProxyConfig.java b/api/src/main/java/net/md_5/bungee/api/ProxyConfig.java
index 4687e7c4..d13923fc 100644
--- a/api/src/main/java/net/md_5/bungee/api/ProxyConfig.java
+++ b/api/src/main/java/net/md_5/bungee/api/ProxyConfig.java
@@ -249,5 +249,13 @@ public interface ProxyConfig
      * @return should the player kicked be transferred to lobby
      */
     boolean isKickToLobby();
+
+    /**
+     * If this is true, the tab list rewriting will be disabled.
+     *
+     * @return should proxy rewrite TabList
+     */
+    boolean isDisableTabListRewrite();
+
     // IvanCord end
 }
diff --git a/proxy/src/main/java/com/github/mrivanplays/ivancord/conf/IvanCordConfiguration.java b/proxy/src/main/java/com/github/mrivanplays/ivancord/conf/IvanCordConfiguration.java
index dea499b2..26bd9f35 100644
--- a/proxy/src/main/java/com/github/mrivanplays/ivancord/conf/IvanCordConfiguration.java
+++ b/proxy/src/main/java/com/github/mrivanplays/ivancord/conf/IvanCordConfiguration.java
@@ -30,6 +30,7 @@ public class IvanCordConfiguration extends WaterfallConfiguration
 {
 
     private boolean kickToLobby = true;
+    private boolean disableTabListRewrite = isOnlineMode();
 
     @Override
     public void load()
@@ -38,5 +39,6 @@ public class IvanCordConfiguration extends WaterfallConfiguration
         YamlConfig config = new YamlConfig( new File( "ivancord.yml" ) );
         config.load( false );
         kickToLobby = config.getBoolean( "kick_to_lobby", kickToLobby );
+        disableTabListRewrite = config.getBoolean( "disable_tablist_rewrite", disableTabListRewrite );
     }
 }
diff --git a/proxy/src/main/java/net/md_5/bungee/connection/DownstreamBridge.java b/proxy/src/main/java/net/md_5/bungee/connection/DownstreamBridge.java
index ee19436e..b8b67261 100644
--- a/proxy/src/main/java/net/md_5/bungee/connection/DownstreamBridge.java
+++ b/proxy/src/main/java/net/md_5/bungee/connection/DownstreamBridge.java
@@ -163,8 +163,19 @@ public class DownstreamBridge extends PacketHandler
     @Override
     public void handle(PlayerListItem playerList) throws Exception
     {
+        // IvanCord start - rewrite the following code
+        /*
         con.getTabListHandler().onUpdate( TabList.rewrite( playerList ) );
         throw CancelSendSignal.INSTANCE; // Always throw because of profile rewriting
+         */
+        boolean skipRewrite = bungee.getConfig().isDisableTabListRewrite();
+        con.getTabListHandler().onUpdate( skipRewrite ? playerList : TabList.rewrite( playerList ) );
+        if ( !skipRewrite )
+        {
+            // only throw when we do rewriting
+            throw CancelSendSignal.INSTANCE;
+        }
+        // IvanCord end
     }
 
     // IvanCord start - remove these from handling
-- 
2.22.0.windows.1

